services:
  # --- INFRAESTRUCTURA ---

  postgres:
    image: postgres:15-alpine
    container_name: postgres-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: "09282325"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - microservicios-net
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M

  config-service:
    image: config-service:latest
    container_name: config-service
    ports:
      - "8888:8888"
    networks:
      - microservicios-net
    volumes:
      - ./config-data:/config-data
    environment:
      - SPRING_PROFILES_ACTIVE=native
      - SPRING_CLOUD_CONFIG_SERVER_NATIVE_SEARCH_LOCATIONS=file:/config-data
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8888/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  eureka-service:
    image: eureka-service:latest
    container_name: eureka-service
    ports:
      - "8761:8761"
    environment:
      - EUREKA_CLIENT_REGISTERWITHUREKA=false
      - EUREKA_CLIENT_FETCHREGISTRY=false
    depends_on:
      - config-service
    networks:
      - microservicios-net

  gateway-service:
    image: gateway-service:latest
    container_name: gateway-service
    ports:
      - "8090:8090"
    environment:
      # El Gateway lee gateway-services.yaml del Config Server
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-service:8888
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-service:8761/eureka/
    depends_on:
      config-service:
        condition: service_healthy
      eureka-service:
        condition: service_started
    networks:
      - microservicios-net

  # --- MICROSERVICIOS DE NEGOCIO ---

  user-service:
    image: user-service:latest
    container_name: user-service
    environment:
      - SPRING_CLOUD_CONFIG_URI=http://config-service:8888
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-service:8888
    depends_on:
      - postgres
      - config-service
      - eureka-service
    networks:
      - microservicios-net

  # ⚠️ RENOMBRADO de tool-service a inventory-service (para coincidir con Gateway)
  inventory-service:
    image: tool-service:latest # Si no cambiaste el nombre en el pom.xml, la imagen sigue llamandose tool-service
    container_name: inventory-service
    environment:
      - SPRING_CLOUD_CONFIG_URI=http://config-service:8888
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-service:8888
    depends_on:
      - postgres
      - config-service
      - eureka-service
    networks:
      - microservicios-net

  amounts-service:
    image: amounts-service:latest
    container_name: amounts-service
    environment:
      - SPRING_CLOUD_CONFIG_URI=http://config-service:8888
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-service:8888
    depends_on:
      - postgres
      - config-service
      - eureka-service
    networks:
      - microservicios-net

  loans-service:
    image: loans-service:latest
    container_name: loans-service
    environment:
      - SPRING_CLOUD_CONFIG_URI=http://config-service:8888
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-service:8888
    depends_on:
      - postgres
      - config-service
      - eureka-service
    networks:
      - microservicios-net

  # ⚠️ OJO: En el Gateway pusiste 'kardexAndMovements-service'. Aquí el nombre del servicio Docker puede ser corto.
  kardex-service:
    image: kardex-service:latest
    container_name: kardex-service
    environment:
      - SPRING_CLOUD_CONFIG_URI=http://config-service:8888
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-service:8888
    depends_on:
      - postgres
      - config-service
      - eureka-service
    networks:
      - microservicios-net

  # ⚠️ RENOMBRADO de customers-service a customer-service (Singular, para coincidir con todo)
  customer-service:
    image: customers-service:latest # Mantén el nombre de imagen que generaste
    container_name: customer-service
    environment:
      - SPRING_CLOUD_CONFIG_URI=http://config-service:8888
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-service:8888
    depends_on:
      - postgres
      - config-service
      - eureka-service
    networks:
      - microservicios-net

  reports-service:
    image: reports-service:latest
    container_name: reports-service
    environment:
      - SPRING_CLOUD_CONFIG_URI=http://config-service:8888
      - SPRING_CONFIG_IMPORT=optional:configserver:http://config-service:8888
    depends_on:
      - postgres
      - config-service
      - eureka-service
    networks:
      - microservicios-net

  keycloak-service:
    image: quay.io/keycloak/keycloak:24.0.1
    container_name: keycloak-service
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres-db:5432/keycloak_db
      KC_DB_USERNAME: postgres
      KC_DB_PASSWORD: "09282325"
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8180:8080"
    command: start-dev
    depends_on:
      - postgres
    networks:
      - microservicios-net

networks:
  microservicios-net:
    driver: bridge

volumes:
  postgres_data: